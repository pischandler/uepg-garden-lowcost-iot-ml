services:
  garden-ml-api:
    build:
      context: .
      dockerfile: ml/Dockerfile
    platform: linux/amd64
    container_name: garden-ml-api
    environment:
      - GML_LOG_LEVEL=INFO
      - GML_SAVE_DEBUG=0
      - GML_ARTIFACTS_DIR=/app/ml/artifacts/model_registry/v0003
      - GML_HOST=0.0.0.0
      - GML_PORT=5000
    ports:
      - "5000:5000"
    volumes:
      - ./ml/artifacts/model_registry:/app/ml/artifacts/model_registry
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:5000/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 3

  garden-ml-dev:
    build:
      context: .
      dockerfile: ml/Dockerfile
    platform: linux/amd64
    working_dir: /app/ml
    volumes:
      - ./:/app
      - ./ml/artifacts/model_registry:/app/ml/artifacts/model_registry
      - ./tools/dataset:/app/ml/dataset
    environment:
      - GML_LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - GML_MLFLOW_TRACKING_URI=file:/app/ml/mlruns
      - GML_MLFLOW_EXPERIMENT=smart-tomato-garden
